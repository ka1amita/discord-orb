version: 2.1
description: Notification for Discord

commands:
  notify:
    parameters:
      webhook_url:
        description: "discord channel webhook url"
        type: string
        default: ${DISCORD_WEBHOOK_URL}
      username:
        type: string
        default: CircleCI
      success_message:
        default: ':green_circle: $CIRCLE_JOB job has succeeded!'
        type: string
        description: success message
      failure_message:
        description: failure message
        type: string
        default: ':red_circle: $CIRCLE_JOB job has failed!'
    steps:
      - run:
          command: |
            echo 'export DISCORD_BUILD_STATUS="success"' >> $BASH_ENV
          name: set failure condition
          when: on_success
      - run:
          command: |
            echo 'export DISCORD_BUILD_STATUS="fail"' >> $BASH_ENV
          name: set failure condition
          when: on_fail
      - run: 
          name: "Notify to Discord"
          command: |
            if [ -z "<< parameters.webhook_url >>"] ; then
              echo "No discrod webhook url set"
              echo "Please input your DISCORD_WEBHOOK_URL value"
              exit 1
            fi

            if [ "$DISCORD_BUILD_STATUS" = "success" ]; then
              curl -H "Content-Type: application/json" -X POST -d "{\"username\": \"CircleCI\",\"content\": \"<< parameters.success_message >>\"}" "<< parameters.webhook_url >>";
            else
              curl -H "Content-Type: application/json" -X POST -d "{\"username\": \"CircleCI\",\"content\": \"<< parameters.failure_message >>\"}" "<< parameters.webhook_url >>";
            fi

examples:
  notify:
    description: Notify 
    usage:
      jobs:
        build:
          docker:
          - image: docker image
          steps:
          - run: exit 0
          - discord-orb/notify:
              webhook_url: webhook
        orbs:
          discord-orb: tkyshm/discrod-orb@0.0.1
        version: 2.1
        workflows:
          your-workflow:
            jobs:
              - bulid
